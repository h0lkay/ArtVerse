{% extends "base.html" %}
{% load static %}

{% block title %}{{ artwork.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/css/artwork_detail.css' %}">
{% endblock %}

{% block content %}
<div class="artwork-detail-container">
    <div class="artwork-detail-header">
        <img class="artwork-image" src="{{ artwork.image.url }}" alt="{{ artwork.title }}">
        <div class="right-panel">
            <div class="artwork-actions">
                {% if artwork.user == request.user %}
                    <a href="{% url 'users:edit_artwork' artwork.id %}" class="edit-button">üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <form method="POST" action="{% url 'users:delete_artwork' artwork.id %}" class="delete-form">
                        {% csrf_token %}
                        <button type="submit" class="delete-button" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?');">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                {% else %}
                    {% if artwork.is_sold %}
                        <button class="disabled-button" disabled>–ü—Ä–æ–¥–∞–Ω–æ</button>
                    {% else %}
                        <button class="buy-button">üõí –ö—É–ø–∏—Ç—å</button>
                    {% endif %}
                    <button id="favorite-btn" class="favorite-button" onclick="toggleFavoriteArtwork({{ artwork.id }})">
                        ‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                    </button>
                {% endif %}
            </div>

            <div class="artwork-description">
                <h1>{{ artwork.title }}</h1>
                <p>{{ artwork.description }}</p>
                <p class="artwork-price">–¶–µ–Ω–∞: {{ artwork.price }} —Ä—É–±.</p>
            </div>

            <div class="artwork-actions">
                {% if artwork.user != request.user %}
                    <a href="{% url 'users:artist_profile' artwork.user.username %}" class="profile-button">
                        üë§ –ü—Ä–æ—Ñ–∏–ª—å —Ö—É–¥–æ–∂–Ω–∏–∫–∞
                    </a>
                    <a href="{% url 'users:start_chat' artwork.id %}" class="message-button">
                        ‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É
                    </a>
                    <button id="follow-btn" class="follow-button" onclick="toggleFavoriteArtist({{ artwork.user.id }})">
                        ‚≠ê –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ö—É–¥–æ–∂–Ω–∏–∫–∞
                    </button>
                {% else %}
                    <p class="author-info">–≠—Ç–æ –≤–∞—à–∞ —Ä–∞–±–æ—Ç–∞!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="artist-portfolio">
        <h2>–î—Ä—É–≥–∏–µ —Ä–∞–±–æ—Ç—ã {{ artwork.user.username }}</h2>
        <div class="portfolio-container">
            {% if artist_portfolio %}
                <div class="portfolio-grid">
                    {% for image in artist_portfolio %}
                        <div class="portfolio-item">
                            <img src="{{ image.image.url }}" alt="{{ image.title }}" class="portfolio-image">
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>–£ —ç—Ç–æ–≥–æ —Ö—É–¥–æ–∂–Ω–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Ä–∞–±–æ—Ç.</p>
            {% endif %}
        </div>
    </div>

    <div class="comments-section">
        <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
    </div>
</div>

<script>
    function toggleFavoriteArtwork(artworkId) {
    fetch(`/users/toggle_favorite_artwork/${artworkId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest",  // –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ AJAX-–∑–∞–ø—Ä–æ—Å–∞
            "Content-Type": "application/json"
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        }
        return response.json();
    })
    .then(data => {
        const button = document.getElementById("favorite-btn");
        if (data.status === "added") {
            button.innerHTML = "‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º";
        } else if (data.status === "removed") {
            button.innerHTML = "‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ";
        }
    })
    .catch(error => {
        console.error("–û—à–∏–±–∫–∞:", error);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
    });
    }

    function toggleFavoriteArtist(artistId) {
    fetch(`/users/toggle_follow_artist/${artistId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/json"
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const button = document.getElementById("follow-btn");
        if (!button) return;

        if (data.status === "followed") {
            button.innerHTML = "‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è";
            button.classList.add("active");
        } else if (data.status === "unfollowed") {
            button.innerHTML = "‚≠ê –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ö—É–¥–æ–∂–Ω–∏–∫–∞";
            button.classList.remove("active");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
    });
    }
</script>

{% endblock %}
